"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[3221,5385],{"./src/tchap/app/initTchap.ts":(e,t,s)=>{s.d(t,{needsRefreshForVersion4:()=>N,queueClearCacheAndReload:()=>T,queueOverideUserSettings:()=>x,registerExpiredAccountListener:()=>v,saveAppVersionInLocalStorage:()=>R});var n=s("./src/dispatcher/dispatcher.ts"),i=s("./src/PlatformPeg.ts"),a=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=s("./src/MatrixClientPeg.ts");class o{static clearCacheAndReload(){console.log(":TCHAP: clearCacheAndReload"),i.A.get()&&(r.J.get().stopClient(),r.J.get().store.deleteAllData().then((()=>{window.location.reload(!0)})))}static getStoreVersion(e,t){return new Promise(((s,n)=>{let i=!0;const a=e.open(t);a.onupgradeneeded=()=>{i=!1},a.onblocked=()=>n(a.error),a.onsuccess=()=>{const r=a.result,o=r.version;r.close(),i||(e.deleteDatabase(t),n("db did not exists")),s(o)},a.onerror=e=>n(a.error)}))}static async saveAppVersion(e){const t=window.localStorage;if(t){const s=await e.getAppVersion();t.setItem(o.VERSION_APP_KEY,s)}}static getAppVersion(){const e=window.localStorage;return e?e&&e.getItem(o.VERSION_APP_KEY):null}}(0,a.A)(o,"SYNC_STORE_NAME","matrix-js-sdk:riot-web-sync"),(0,a.A)(o,"VERSION_APP_KEY","tchap_app_version");class c{static override(){}}var l=s("./src/tchap/util/TchapUIFeature.ts"),E=s("./node_modules/matrix-js-sdk/src/matrix.ts"),d=s("./src/Lifecycle.ts"),A=s("./src/Modal.tsx"),p=s("./node_modules/matrix-js-sdk/src/logger.ts"),u=s("./node_modules/react/index.js"),h=s("./src/languageHandler.tsx"),m=s("./src/components/views/dialogs/BaseDialog.tsx"),_=s("./src/components/views/elements/DialogButtons.tsx"),S=s("./src/components/views/elements/InlineSpinner.tsx"),C=s("./src/tchap/util/TchapUtils.ts"),I=function(e){return e[e.START=0]="START",e[e.SENDING_EMAIL=1]="SENDING_EMAIL",e[e.EMAIL_MUST_WAIT=2]="EMAIL_MUST_WAIT",e[e.EMAIL_SUCCESS=3]="EMAIL_SUCCESS",e[e.EMAIL_FAILURE=4]="EMAIL_FAILURE",e[e.ACCOUNT_STILL_EXPIRED=5]="ACCOUNT_STILL_EXPIRED",e[e.ACCOUNT_RENEWED=6]="ACCOUNT_RENEWED",e}(I||{});class w extends u.Component{constructor(e){super(e),(0,a.A)(this,"onOk",(async()=>{if(this.state.ProcessState===I.ACCOUNT_RENEWED)return this.props.onFinished();await C.A.isAccountExpired()?this.setState({ProcessState:I.ACCOUNT_STILL_EXPIRED}):this.setState({ProcessState:I.ACCOUNT_RENEWED})})),(0,a.A)(this,"onRequestEmail",(()=>{if(this.mustWait())return this.setState({ProcessState:I.EMAIL_MUST_WAIT});this.setState({ProcessState:I.SENDING_EMAIL}),this.props.onRequestNewEmail().then((e=>{this.setState({newEmailSentTimestamp:e?Date.now():this.state.newEmailSentTimestamp,ProcessState:e?I.EMAIL_SUCCESS:I.EMAIL_FAILURE})}))})),this.state={newEmailSentTimestamp:0,emailDelaySecs:this.props.emailDelaySecs||30,ProcessState:I.START}}mustWait(){return 0!=this.state.newEmailSentTimestamp&&Date.now()-this.state.newEmailSentTimestamp<1e3*this.state.emailDelaySecs}render(){let e=(0,h._t)("The validity period of your account has expired"),t=u.createElement("p",null,(0,h._t)("An email has been sent to you. Click on the link it contains, click below.")),s=null,n=u.createElement("button",{onClick:this.onRequestEmail},(0,h._t)("Request a renewal email")),i=(0,h._t)("I renewed the validity of my account");switch(this.state.ProcessState){case I.SENDING_EMAIL:s=u.createElement(S.A,null);break;case I.EMAIL_MUST_WAIT:s=u.createElement("p",{className:""},(0,h._t)("Wait for at least %(wait)s seconds between two emails",{wait:this.state.emailDelaySecs}));break;case I.EMAIL_FAILURE:s=u.createElement("p",{className:"text-error"},(0,h._t)("The email was not sent sucessfully, please retry in a moment"));break;case I.EMAIL_SUCCESS:s=u.createElement("p",{className:"text-success"},(0,h._t)("A new email has been sent"));break;case I.ACCOUNT_STILL_EXPIRED:s=u.createElement("p",{className:"text-error"},(0,h._t)("Your account is still expired, please follow the link in the email you have received to renew it"));break;case I.ACCOUNT_RENEWED:e=(0,h._t)("Congratulations, your account has been renewed"),t=u.createElement("p",null,(0,h._t)("You can refresh the page to continue your conversations")),i=(0,h._t)("Reload page"),s=null,n=null}return u.createElement(m.A,{className:"mx_QuestionDialog",onFinished:this.props.onFinished,title:e,contentId:"mx_Dialog_content",hasCancel:!1},s,u.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},t),u.createElement(_.A,{primaryButton:i,hasCancel:!1,onPrimaryButtonClick:this.onOk},n))}}const g=new class{constructor(){(0,a.A)(this,"boundOnExpiredAccountEvent",void 0),(0,a.A)(this,"dispatcher",void 0),(0,a.A)(this,"isPanelOpen",void 0),(0,a.A)(this,"isAccountExpired",void 0),this.boundOnExpiredAccountEvent=this.onExpiredAccountError.bind(this),this.dispatcher=n.A,this.isPanelOpen=!1,this.isAccountExpired=!1}register(){const e=this.dispatcher.register((t=>{if("will_start_client"===t.action){p.v.debug(":tchap: register a listener for HttpApiEvent.ORG_MATRIX_EXPIRED_ACCOUNT events");r.J.safeGet().on(E.HttpApiEvent.ORG_MATRIX_EXPIRED_ACCOUNT,this.boundOnExpiredAccountEvent),this.dispatcher.unregister(e)}}))}onExpiredAccountError(){p.v.debug(":tchap: Expired Account Error received"),this.isPanelOpen||((0,d.NN)(!1),p.v.debug(":tchap: matrix react services have been shutdown"),this.showExpirationPanel(),this.isPanelOpen=!0)}async showExpirationPanel(){A.Ay.createDialog(w,{onRequestNewEmail:()=>C.A.requestNewExpiredAccountEmail(),onFinished:async()=>{this.isPanelOpen=!1,i.A.get().reload()}},void 0,!1,!0,{onBeforeClose:async()=>(this.isAccountExpired=await C.A.isAccountExpired(),Promise.resolve(!this.isAccountExpired))})}};async function N(){if(!l.A.activateClearCacheAndReloadAtVersion4)return!1;let e;try{e=window.indexedDB}catch(e){}if(!e)return!1;if(o.getAppVersion()){const e=o.getAppVersion(),t=parseInt(e.charAt(0),10);return!isNaN(t)&&t<4}try{return await o.getStoreVersion(e,o.SYNC_STORE_NAME)<4}catch(e){return console.warn(e),!1}}function T(){const e=n.A.register((t=>{"client_started"===t.action&&(n.A.unregister(e),o.clearCacheAndReload())}))}function x(){const e=n.A.register((t=>{"client_started"===t.action&&(c.override(),n.A.unregister(e))}))}function R(){o.saveAppVersion(i.A.get())}function v(){g.register()}}}]);
//# sourceMappingURL=initTchap.js.map